---
title: "Final Project"
author: "Emely Gazarov, Ryo Iwata, Maria Ramirez"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidymodels)
library(knitr)
library(car)
# install.packages("ggalluvial")
library(ggalluvial)
# install.packages("circlize")
library(circlize)
library(stringr)
# install.packages("cowplot")
library(cowplot)
# install.packages("ggpie")
library(ggpie)
# to control default number formatting, no need for specifying digits in kable.
# install.packages("ggheatmap")
library(ggheatmap)
# install.packages("ggcorrplot")
library(ggcorrplot)

options(scipen = 3, digits = 5) 
```

```{r}
cleaned_addiction_data = read_rds("./addiction.rds") |>
  # mutate(commit_change = (commit.DC - commit.BL) / (commit.BL + commit.DC))
  mutate(commit_change = (commit.DC - commit.BL)) |>
  mutate(no_social_qol.BL = (qol_general_health.BL + qol_psych.BL + qol_physical.BL + qol_env.BL)/23)


```

```{r}
cleaned_addiction_data 
```

# Overview of what we're working with

### Things that can predict
- number of sober days
- days since baseline
- age
- gender
- education
- drop out yes no
- SUD is alcholoc
- SUD is other
- Social support
  - family
  - friends
  - sig other
  - total
- Substance use history
  - Tried tobacco/alcohol
  - Age of first use
  - Regular use
  - Age of regular use
- AA/NA affiliation
  - Lifetime number of meetings
  - Last year number of meetings
  - Degree of affiliation
  - Positive thoughts
  - Negative thoughts
- Stressful life
  - happened
  - witnessed
  - learned about
  - exposed
  - total of all things
- Childhood
- Religion
  - Religious affiliation
  - Positive
  - Negative
- Life quality

### Things we can predict
- impression change
- length of stay
- Life quality
- Commitment to change
- Cravings
  - baseline
  - baseline vs followup
- Impression of change

# First hypothesis

```{r}
commitment_model <- lm(commit_change ~ age 
                + gender
                + education
                + rel.is_religious
                + religion_pos
                + aana_past_year
                + SUD.sum_illegal
                + SUD.sum_legal
                ,cleaned_addiction_data)
```

```{r}
# and now the Q-Q plots
cleaned_addiction_data |>
  ggplot(aes(sample=commit_change)) +
  stat_qq() +
  stat_qq_line() +
  labs(
    title = "Q-Q plot of difference of commitment to change at baseline to discharge",
    y = "Commitment to change quantiles",
    x = "Normal distribution quantiles")
```

```{r}
# and now the Q-Q plots
cleaned_addiction_data |>
  ggplot(aes(commit.BL)) +
  geom_histogram() +
  labs(
    title = "Distribution of baseline abstaining confidence")
```

```{r}
# and now the Q-Q plots
cleaned_addiction_data |>
  ggplot(aes(sample=commit.BL)) +
  stat_qq() +
  stat_qq_line() +
  labs(
    title = "Q-Q plot of commitment to change at baseline",
    y = "Commitment to change quantiles",
    x = "Normal distribution quantiles")
```

# Looking for other normally distributed things to predict

```{r}
# and now the Q-Q plots
cleaned_addiction_data |>
  ggplot(aes(sample=craving.BL)) +
  stat_qq() +
  stat_qq_line() +
  labs(
    title = "Q-Q plot of craving scale at baseline",
    y = "Craving scale quantiles",
    x = "Normal distribution quantiles")
```
```{r}
# and now the Q-Q plots
cleaned_addiction_data |>
  ggplot(aes(sample=abstain_total.BL)) +
  stat_qq() +
  stat_qq_line() +
  labs(
    title = "Q-Q plot of abstaining confidence at baseline",
    y = "Abstaining confidence quantiles",
    x = "Normal distribution quantiles")
```

```{r}
# and now the Q-Q plots
cleaned_addiction_data |>
  ggplot(aes(sample=qol.BL)) +
  stat_qq() +
  stat_qq_line() +
  labs(
    title = "Q-Q plot of quality of life at baseline",
    y = "Quality of life quantiles",
    x = "Normal distribution quantiles")
```

```{r}
# and now the Q-Q plots
cleaned_addiction_data |>
  ggplot(aes(qol.BL)) +
  geom_histogram() +
  labs(
    title = "Distribution of quality of life")
```

```{r}
# and now the Q-Q plots
cleaned_addiction_data |>
  ggplot(aes(sample=no_social_qol.BL)) +
  stat_qq() +
  stat_qq_line() +
  labs(
    title = "Q-Q plot of quality of life without social component at baseline",
    y = "Quality of life quantiles",
    x = "Normal distribution quantiles")
```



```{r}
# and now the Q-Q plots
cleaned_addiction_data |>
  ggplot(aes(no_social_qol.BL)) +
  geom_histogram() +
  labs(
    title = "Distribution of quality of life without social component")
```




```{r}
qol_model <- lm(no_social_qol.BL ~ age 
                + gender
                + education
                + SUD.sum_illegal
                + SUD.sum_legal
                + rel.is_religious
                + religion_pos
                + aana_past_year
                + aana_positive
                + social
                + stress_to_subj
                ,cleaned_addiction_data)
```

```{r}
summary(qol_model)
```

```{r}

Anova(qol_model, type=2, digits=4) |>
tidy() |>
  kable() 
```

```{r}
```

# Plotting the adjusted data


```{r}
tidy_qol_model <- tidy(qol_model)

# Getting the coefficient
coef_social <- 
  pull(filter(tidy_qol_model, 
              term == "social"), 
       estimate)

coef_stress_to_subj <- 
  pull(filter(tidy_qol_model, 
              term == "stress_to_subj"), 
       estimate)

coef_aana_past_year <- 
  pull(filter(tidy_qol_model, 
              term == "aana_past_year"), 
       estimate)

coef_aana_positive <- 
  pull(filter(tidy_qol_model, 
              term == "aana_positive"), 
       estimate)

coef_religion_pos  <- 
  pull(filter(tidy_qol_model, 
              term == "religion_pos"), 
       estimate)

# Adjusting for Glu or PLP

adjusted_addiction_data <- augment(qol_model) |>
  mutate(QOL_adjusted = 
           no_social_qol.BL - 
           stress_to_subj * coef_stress -
           aana_positive * coef_aana_positive -
           religion_pos * coef_religion_pos)


```



```{r}
intercept = pull(filter(tidy_qol_model, term == "(Intercept)"), estimate)
stress_to_subj_slope = pull(filter(tidy_qol_model, term == "stress_to_subj"), estimate)
aana_positive_slope = pull(filter(tidy_qol_model, term == "aana_positive"), estimate)
religion_pos_slope = pull(filter(tidy_qol_model, term == "religion_pos"), estimate)

stress_to_subj_mean = mean(adjusted_addiction_data$stress_to_subj)
aana_positive_mean = mean(adjusted_addiction_data$aana_positive)
religion_pos_mean = mean(adjusted_addiction_data$religion_pos)

```

```{r}
adjusted_addiction_data |>
  ggplot(aes(social, QOL_adjusted, color=education)) +
  geom_point() +
  geom_abline(slope=coef_social, intercept = intercept + 
                stress_to_subj_slope * stress_to_subj_mean +
                aana_positive_slope * aana_positive_mean +
                religion_pos_slope * religion_pos_mean, size=1) +
  facet_wrap(vars(education)) +
  labs(title="Quality of life adjusted for stress, AANA positive, positive religious coping")
```

```{r}
adjusted_addiction_data |>
  ggplot(aes(social, QOL_adjusted, color=rel.is_religious)) +
  geom_point() +
  geom_abline(slope=coef_social, intercept = intercept + 
                stress_to_subj_slope * stress_to_subj_mean +
                aana_positive_slope * aana_positive_mean +
                religion_pos_slope * religion_pos_mean, size=1) +
  facet_wrap(vars(rel.is_religious)) +
  labs(title="Quality of life adjusted for stress, AANA positive, positive religious coping")
```
```{r}
adjusted_addiction_data |>
  ggplot(aes(social, QOL_adjusted, color=gender)) +
  geom_point() +
  geom_abline(slope=coef_social, intercept = intercept + 
                stress_to_subj_slope * stress_to_subj_mean +
                aana_positive_slope * aana_positive_mean +
                religion_pos_slope * religion_pos_mean, size=1) +
  facet_wrap(vars(gender)) +
  labs(title="Quality of life adjusted for stress, AANA positive, positive religious coping")
```


```{r}
adjusted_addiction_data |> 
  ggplot(aes(adjusted_addiction_data))
```

```{r}
str(cleaned_addiction_data)
```
```{r}
cleaned_addiction_data |>
  select(age) |>
  str()
```


```{r}
qol_model
```



## 1.E. Using your models from C and D, calculate activity after removing the estimated contribution of (1) glutamate and (2) pyridoxal phosphate concentrations (note: create 2 new variables). Recreate figure 1.B.3 for each of these with a separate facet for each (will require some data carpentry). (10 pt)


```{r}
# Getting the glutamate coefficient
glu_coef_for_variant_and_glu_to_activity <- 
  pull(filter(variant_and_glu_to_activity_tidy, 
              term == "Glu"), 
       estimate)

# Getting the glutamate coefficient
PLP_coef_for_variant_and_glu_to_activity <-
  pull(filter(variant_and_PLP_to_activity_tidy, 
              term == "`pyridoxal phosphate conc.`"), 
       estimate)

# Adjusting for Glu or PLP
glu_and_PLP_adjusted_gad65_data <- 
  fixed_gad65_data |>
  mutate(`Glu adjusted` = 
           `Enz Activity` - 
           Glu * glu_coef_for_variant_and_glu_to_activity,
         `PLP adjusted` = 
           `Enz Activity` - 
           `pyridoxal phosphate conc.` * PLP_coef_for_variant_and_glu_to_activity) |>
  pivot_longer(cols=c(`Enz Activity`, `Glu adjusted`, `PLP adjusted`), 
               values_to = "Enz Activity")

\newpage
# Looking at model metrics

```{r}
interaction_model <- lm(no_social_qol.BL ~ age 
                + gender
                + education
                + SUD.sum_illegal
                + SUD.sum_legal
                + rel.is_religious * religion_pos
                + aana_past_year
                + aana_positive
                + social
                + stress_to_subj
                ,cleaned_addiction_data)

social_only_model <- lm(no_social_qol.BL ~ age 
                + gender
                + education
                + SUD.sum_illegal
                + SUD.sum_legal
                + social
                ,cleaned_addiction_data)

with_religion_model <- lm(no_social_qol.BL ~ age 
                + gender
                + education
                + SUD.sum_illegal
                + SUD.sum_legal
                + social
                + rel.is_religious * religion_pos
                ,cleaned_addiction_data)

with_aana_model <- lm(no_social_qol.BL ~ age 
                + gender
                + education
                + SUD.sum_illegal
                + SUD.sum_legal
                + social
                + aana_past_year
                + aana_positive
                ,cleaned_addiction_data)

with_stress_model <- lm(no_social_qol.BL ~ age 
                + gender
                + education
                + SUD.sum_illegal
                + SUD.sum_legal
                + social
                + stress_to_subj
                ,cleaned_addiction_data)
```

\newpage
```{r}
kable(AIC(qol_model, interaction_model, social_only_model, with_aana_model, with_religion_model, with_stress_model))
```


```{r}

```


