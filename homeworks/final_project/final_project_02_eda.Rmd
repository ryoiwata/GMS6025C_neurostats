---
title: "Final Project"
author: "Emely Gazarov, Ryo Iwata, Maria Ramirez"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidymodels)
library(knitr)
library(car)
# install.packages("ggalluvial")
library(ggalluvial)
# install.packages("circlize")
library(circlize)
library(stringr)
# install.packages("cowplot")
library(cowplot)
# install.packages("ggpie")
library(ggpie)
# to control default number formatting, no need for specifying digits in kable.
# install.packages("ggheatmap")
library(ggheatmap)
# install.packages("ggcorrplot")
library(ggcorrplot)

options(scipen = 3, digits = 5) 
```

```{r}
cleaned_addiction_data = read_rds("./addiction.rds")
```

```{r}
cleaned_addiction_data
```

# Overview of what we're working with

### Things that can predict
- number of sober days
- days since baseline
- age
- gender
- education
- drop out yes no
- SUD is alcholoc
- SUD is other
- Social support
  - family
  - friends
  - sig other
  - total
- Substance use history
  - Tried tobacco/alcohol
  - Age of first use
  - Regular use
  - Age of regular use
- AA/NA affiliation
  - Lifetime number of meetings
  - Last year number of meetings
  - Degree of affiliation
  - Positive thoughts
  - Negative thoughts
- Stressful life
  - happened
  - witnessed
  - learned about
  - exposed
  - total of all things
- Childhood
- Religion
  - Religious affiliation
  - Positive
  - Negative
- Life quality

### Things we can predict
- impression change
- length of stay
- Life quality
- Commitment to change
- Cravings
  - baseline
  - baseline vs followup
- Impression of change

# Looking at the basic demographics
```{r}
install.packages("ggcorrplot")
```

```{r}
cleaned_addiction_data |>
  select(ends_with("baseline")) |> 
  cor() |>
  ggcorrplot()
  
```


```{r}
# donut plot
p2=ggrosepie(cleaned_addiction_data, group_key = "gender", count_type = "full", label_info = "all",
             donut_frac=0.3,donut_label_size=3) + 
  labs(title = "Sex distribution")

cowplot::plot_grid(p2)
```

```{r}
#donut plot
p2=ggrosepie(cleaned_addiction_data, group_key = c("gender","education"),
             count_type = "full",
             show_tick=F, donut_frac=NULL) +
  theme(plot.margin = unit(c(1,1,1,1), "cm")) + # Adjust top, right, bottom, left margins
  labs(title = "Distribution of education")

cowplot::plot_grid(p2) 

```


```{r}

age_mean <- cleaned_addiction_data |>
  group_by(gender) %>%
  summarize(mean = mean(age))

# ggplot(data, aes(x=Accuracy, fill=Modality)) +
#   geom_density(alpha=0.4)+
#   facet_wrap(. ~ Species) +
#   xlab("Accuracy") + ylab("Density") +
#   geom_vline(data = dummy, aes(xintercept = mean, color = Modality))

cleaned_addiction_data |> ggplot(aes(age,  group=gender, fill=gender)) +
  geom_density(alpha=.4) +
  labs(title = "Age distribution")

```
```{r}
cleaned_addiction_data |> ggplot(aes(SUD.sum, color=gender, fill=gender)) +
  geom_histogram(bins = 8) +
  facet_wrap(vars(gender)) +
  labs(title = "Distribution of addicted substances")
```


```{r}
cleaned_addiction_data |> ggplot(aes(age,  group=gender, fill=gender)) +
  geom_histogram(alpha=0.4, binwidth = 10) +
  facet_wrap(vars(education))
```
```{r}

# Function to calculate co-occurrences
co_occurrence <- function(df) {
  n <- ncol(df)
  mat <- matrix(0, n, n, dimnames = list(colnames(df), colnames(df)))

  for (i in 1:n) {
    for (j in i:n) {
      if (i == j) {
        mat[i, j] <- sum(df[[i]] == 1)
      } else {
        mat[i, j] <- sum(df[[i]] == 1 & df[[j]] == 1)
        mat[j, i] <- mat[i, j]  # Symmetric matrix
      }
    }
  }
  mat
}

# co_occurrence_modified <- function(df) {
#   n <- ncol(df)
#   mat <- matrix(0, n, n, dimnames = list(colnames(df), colnames(df)))
#   
#   for (i in 1:(n-1)) {  # Adjust loop to stop before the last column
#     for (j in (i+1):n) {  # Start from the next column to avoid repeats and self-comparison
#       # Calculate co-occurrence only for unique pairs (i != j)
#       mat[i, j] <- sum(df[[i]] == 1 & df[[j]] == 1)
#       mat[j, i] <- mat[i, j]  # Ensure the matrix is symmetric
#     }
#   }
#   
#   # Ensure diagonal and any revisited pairs are set to zero
#   # This step is somewhat redundant with the above control but ensures no self-pair counts
#   diag(mat) <- 0
#   
#   mat
# }

# Create the matrix
matrix_for_chord <- cleaned_addiction_data |>
  select(starts_with("SUD")) |>
  select(-ends_with("sum")) |>
  rename_all(~stringr::str_replace(., "SUD.is_", "")) |>
  co_occurrence()
```

```{r}
grid.col <- setNames(rainbow(length(unlist(dimnames(matrix_for_chord)))), union(rownames(matrix_for_chord), colnames(matrix_for_chord)))

chordDiagram(matrix_for_chord, annotationTrack = "grid", preAllocateTracks = 1, grid.col = grid.col) 

circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index")
  circos.text(mean(xlim), ylim[1] + .5, sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
  circos.axis(h = "top", labels.cex = 0.5, sector.index = sector.name, track.index = 2)
}, bg.border = NA)
```


```{r}
# install.packages("reshape2")
library(reshape2)
melted_cormat <- melt(matrix_for_chord)

ggplot(data = melted_cormat, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile() +
  scale_colour_gradientn(colours="Blues")
```

```{r}
# ggheat(matrix_for_chord)
```

```{r}
cleaned_addiction_data |> ggplot(aes(number_of_days_in_treatment)) +
  geom_histogram() +
  facet_wrap(vars(dropout_yn))
```



```{r}
filtered_alcohol_data <- cleaned_addiction_data |>
  # Getting only the people that are addicted to alcohol
  filter(SUD.is_Alchohol == 1) |>
  filter(SUD.sum == 1) 

filtered_alcohol_data

filtered_cocaine_data <- cleaned_addiction_data |>
  # Getting only the people that are addicted to alcohol
  filter(SUD.is_Cocaine == 1)

filtered_cocaine_data

```

```{r}
filtered_alcohol_data |> ggplot(aes(abstain_confidence_pos_mean_baseline)) +
  geom_histogram()

filtered_alcohol_data |> ggplot(aes(abstain_confidence_neg_mean_baseline)) +
  geom_histogram()
```

```{r}
filtered_cocaine_data |> ggplot(aes(abstain_confidence_pos_mean_baseline)) +
  geom_histogram()

filtered_cocaine_data |> ggplot(aes(abstain_confidence_neg_mean_baseline)) +
  geom_histogram()

filtered_cocaine_data |> ggplot(aes(abstain_confidence_crv_mean_baseline)) +
  geom_histogram()

filtered_cocaine_data |> ggplot(aes(abstain_confidence_crv_mean_followup)) +
  geom_histogram()
```

```{r}
cleaned_addiction_data |> ggplot(aes(social_support.total)) +
  geom_histogram() 

cleaned_addiction_data |> ggplot(aes(social_support.fam_sub_total)) +
  geom_histogram() 

cleaned_addiction_data |> ggplot(aes(social_support.friends_sub_total)) +
  geom_histogram() 

cleaned_addiction_data |> ggplot(aes(social_support.sig_other_sub_total)) +
  geom_histogram() 
```
```{r}
cleaned_addiction_data |> ggplot(aes(qol.general_health_baseline)) +
  geom_histogram()

cleaned_addiction_data |> ggplot(aes(qol.psychological_health_baseline)) +
  geom_histogram()

cleaned_addiction_data |> ggplot(aes(qol.physical_health_baseline)) +
  geom_histogram()

cleaned_addiction_data |> ggplot(aes(qol.social_health_baseline)) +
  geom_histogram()

cleaned_addiction_data |> ggplot(aes(qol.environmental_health_baseline)) +
  geom_histogram()
```

```{r}
cleaned_addiction_data |> ggplot(aes(qol.general_health_followup)) +
  geom_histogram()

cleaned_addiction_data |> ggplot(aes(qol.psychological_health_followup)) +
  geom_histogram()

cleaned_addiction_data |> ggplot(aes(qol.physical_health_followup)) +
  geom_histogram()

cleaned_addiction_data |> ggplot(aes(qol.social_health_followup)) +
  geom_histogram()

cleaned_addiction_data |> ggplot(aes(qol.environmental_health_followup)) +
  geom_histogram()
```

```{r}
counts <- colSums(select(factored_addiction_data, starts_with("SUD.is_")) == 1)

counts_df <- as.data.frame(counts) |>
  mutate(column_names = row.names(counts_df)) |>
  mutate(column_names = str_replace(column_names, "SUD.is_", "")) |>
  mutate(column_names = str_replace_all(column_names, "_", " "))

  

counts_df |> ggplot(aes(column_names, counts)) +
  geom_bar(stat="identity") +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Distribution of addicted substances")
```

```{r}
cleaned_addiction_data |> 
  ggplot(aes(number_of_days_in_treatment)) +
  geom_histogram() +
  facet_wrap(vars(SUD.does_illegal_drugs))
```

```{r}
cleaned_addiction_data |> ggplot(aes(x=social_support.fam_sub_total, y=qol.psychological_health_baseline)) +
  geom_jitter() +
  facet_wrap(vars(SUD.is_Cocaine))

cleaned_addiction_data |> ggplot(aes(x=social_support.fam_sub_total, y=qol.psychological_health_followup)) +
  geom_jitter() +
  facet_wrap(vars(SUD.is_Cocaine))
  
```

```{r}
filtered_cocaine_data |> ggplot(aes(x=stressful_life.happened_to_you_and_witnessed_total, y=qol.psychological_health_baseline)) +
  geom_jitter() 

filtered_cocaine_data |> ggplot(aes(x=stressful_life.happened_to_you_and_witnessed_total, y=qol.psychological_health_followup)) +
  geom_jitter() 
  
```

```{r}
cleaned_addiction_data |> ggplot(aes(x=stressful_life.happened_to_you_and_witnessed_total, y=SUD.sum)) +
  geom_jitter() 
```

```{r}
filtered_alcohol_data |> ggplot(aes(x=stressful_life.happened_to_you_and_witnessed_total, y=number_of_days_in_treatment)) +
  geom_jitter() 
```

```{r}
filtered_alcohol_data |> ggplot(aes(x=aana_affiliation.tspe_positive, y=number_of_days_in_treatment)) +
  geom_jitter() 
```

```{r}
filtered_alcohol_data |> ggplot(aes(x=aana_affiliation.tspe_negative, y=number_of_days_in_treatment)) +
  geom_jitter() 
```

```{r}
cleaned_addiction_data |> 
  filter(stressful_life.physical_assault.happened_to_you == 1) |>
  ggplot(aes(qol.mean_baseline)) +
  geom_histogram()

cleaned_addiction_data |> 
  filter(stressful_life.happened_to_you_total == 0) |>
  ggplot(aes(qol.mean_baseline)) +
  geom_histogram()

```

```{r}
filtered_cocaine_data |> 
  ggplot(aes(x=stressful_life.happened_to_you_total, y=abstain_confidence_neg_mean_baseline)) +
  geom_jitter()
```

```{r}
cleaned_addiction_data |> 
  ggplot(aes(x=stressful_life.happened_to_you_total, y=abstain_confidence_crv_mean_baseline)) +
  geom_jitter()
```

