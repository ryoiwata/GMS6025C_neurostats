---
title: "HW1"
author: "Ryo Iwata"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidymodels)
library(car)
library(knitr)
```

*Nota bene* - Use car::Anova unless otherwise specified throughout this course, the reasons for which will be covered in detail in a later lecture. You can do so by using library(car) then Anova or car::Anova, assuming the car package is installed. With our simple models, it isn't different from the normal anova function, but it is a good habit to get into.

Each problem should have its own data loading and carpentry chunk

# Problem \#1 (40 pts):
Your laboratory is studying the effect of the diffusion of intraventricular drug delivery vehicles (particles) and are currently evaluating the impact of the polymer used. load and prepare data from sheet DataSet1.

```{r Data Loading}

polymer_data <- readxl::read_excel("./data/HW1_Data.xlsx", sheet="DataSet1")
implant_data <- readxl::read_excel("./data/HW1_Data.xlsx", sheet="DataSet2")
bnp_data <- readxl::read_excel("./data/HW1_Data.xlsx", sheet="DataSet3")


```

```{r Data carpentry}
str(polymer_data)

polymer_1 <- polymer_data |> 
  select("Polymer Type...1", "Diffusion Rate...2") |> 
  rename(polymer_type = "Polymer Type...1") |>
  rename(diffusion_rate = "Diffusion Rate...2")

polymer_2 <- polymer_data |> 
  select("Polymer Type...3", "Diffusion Rate...4") |>
  rename(polymer_type = "Polymer Type...3") |>
  rename(diffusion_rate = "Diffusion Rate...4")

polymer_restructured <- bind_rows(polymer_1, polymer_2)


```

```{r}

implant_restructured <- pivot_longer(implant_data, colnames(implant_data))

```

```{r}
bnp_restructured <- bnp_data |> 
  rename(bnp_decrease_with_furosemide="Decrease in BNP After Treatment With Furosemide") |>
  rename(bnp_decrease_with_hydrochlorothiazide="Decrease in BNP After Treatment With Hydrochlorothiazide") |>
  rename(bnp_decrease_with_ethacrynic_acid="Decrease in BNP After Treatment With Ethacrynic Acid") |>
  rename(bnp_decrease_with_metolazone="Decrease in BNP After Treatment With Metolazone") 


bnp_restructured <- pivot_longer(bnp_restructured, colnames(bnp_restructured))

```


## 1) Create a set of plots that allow you to visualize the distribution of the diffusion of each particle type that emphasizes/aids in visual consideration of particular characteristics:

### a) Focused on the distribution within polymer type (4 pts)

```{r}
polymer_restructured |> ggplot(aes(x=diffusion_rate)) + 
  geom_histogram(bins = 5) +
  facet_wrap(vars(polymer_type))
```

### b) Focused on relationship beteen the distributions (4 pts)

```{r}

polymer_restructured |> ggplot(aes(x=diffusion_rate, group=polymer_type, fill=polymer_type)) +
    geom_density(alpha=.4)

```



## 2) Fit a regression model (lm) to capture the effect of polymer type on diffusion. (2pts)

### a) What are the coefficients for this model (4 pts)?

```{r}
polymer_restructured |>
  group_by(polymer_type) |>
  summarise(avg = mean(diffusion_rate))
```


```{r summary(polymer_lm) output}
polymer_lm <- lm(diffusion_rate ~ polymer_type, polymer_restructured) 

summary(polymer_lm)
```


```{r}
car::Anova(polymer_lm)
```
**Answer: The coefficients for this model is the mean diffusion rate of every polymer type subtracted by the intercept. One group's mean is the intercept, which does not have a corresponding coefficient. **

### b) Which group is serving as the intercept (2 pts)?

**Answer: In this model, Chitosan is serving as the intercept which can be seen in the output of `summary(polymer_lm)` which shows that Chitosan is not one of the groups that has a coefficient.**


### c) Using these coefficients (and not the source data), calculate the model's estimated means for each group (4 pts)?

```{r}

tidy_polymer <- tidy(polymer_lm)

mean_chitosan <- pull(filter(tidy_polymer, term=="(Intercept)"), estimate)
mean_dextran <- mean_chitosan + pull(filter(tidy_polymer, term=="polymer_typeDextran"), estimate)
mean_plga <- mean_chitosan + pull(filter(tidy_polymer, term=="polymer_typePLGA"), estimate)
mean_silica <- mean_chitosan + pull(filter(tidy_polymer, term=="polymer_typeSilica"), estimate)

print(paste("Mean diffusion rate of Chitosan: ", mean_chitosan))
print(paste("Mean diffusion rate of Dextran: ", mean_dextran))
print(paste("Mean diffusion rate of PLGA: ", mean_plga))
print(paste("Mean diffusion rate of Silica: ", mean_silica))

```



### d) Calculate (using a tidyverse appraoch) the SS~total~, SS~Regression~, and SS~Error~ for this model (5 pts)?

```{r}
# Calculating the mean for all the diffusion rates
polymer_restructured <- polymer_restructured |> 
  mutate(mean_all = mean(diffusion_rate))


ss_total <- sum((polymer_restructured$diffusion_rate - polymer_restructured$mean_all)^2)
```

```{r}
# Calculating the predicted values
polymer_restructured <- polymer_restructured |> 
  mutate(y_pred = fitted(polymer_lm))

# Calculate SS_Regression 
ss_regression <- sum((polymer_restructured$y_pred - polymer_restructured$mean_all)^2)

```

```{r}
# Calculate SS_Error (Residual Sum of Squares)
ss_error <- sum((polymer_restructured$y_pred - polymer_restructured$diffusion_rate)^2)
```


### e) Write out the formula for this model using the beta notation discussed in class  (2 pts)?

**Answer: **

$$y_i = \beta_0 + \beta_1x_i + \epsilon_i$$


## 3) Using the estimates and their associated error for the above model, use a t-test to evaluate whether the term is zero or non-zero.

```{r}

non_zero_terms <- pull(filter(tidy_polymer, p.value < 0.05),  term)

zero_terms <- pull(filter(tidy_polymer, p.value >= 0.05),  term)

print(paste0("Non-zero term: ", non_zero_terms))

print(paste0("Zero term: ", zero_terms))

```


### a) What are the t-statistic and associated p-value. Note-no calculation necessary, we aready have this information (3 pts)?

```{r}
pull(tidy_polymer,  term)
```


### b) What do these coefficient/estimate terms represent. List and explain each. (3 pt)?

**Answer: `(Intercept)` is the y-value that the model would cross when all other variables are 0. In this case, it is the mean diffusion rate of the Chitosan group. `polymer_typeDextran` is the coefficient for the variable of whether a data point is in the Dextran group or not. The coefficient is equal to the mean diffusion rate of the Dextran group. `polymer_typePLGA` is the coefficient for the variable of whether a data point is in the PLGA group or not. The coefficient is equal to the mean diffusion rate of the PLGA group.  `polymer_typeSilica` is the coefficient for the variable of whether a data point is in the Silica group or not. The coefficient is equal to the mean diffusion rate of the Silica group. **  


### c) Which polymers differ from PLGA (ignoring consideration of multiple comparisons/post-hoc testing) (2 pt)?

```{r}

# For pairwise comparison without considering multiple testing corrections
pairwise_t_test_results <- pairwise.t.test(polymer_restructured$diffusion_rate, polymer_restructured$polymer_type)

pull(filter(pairwise_t_test_results, ))
```


## 4) Create two essentially visually identical figures to show both the raw data and the model. 1) from the augmented data (augment function in tidymodels). and 2) Use the outputs of the model fit (lm) to calculate the model's predicted values for each group to include in the plot, and only plotting a single value for each such predicted value for each group (i.e., not using stat_summary or equivalent and with the calculated predicted value in a separate tibble from the data) (7 pt):

```{r}

```


# Problem #2 (30 pts):  Your group is investigating the encapsulation rate of long-term transcranial implants.  In your study, subjects have been implanted with a implants then placed on different therapeutic regimens after implantation.  In your study, four different drugs/formulatio   ns were used â€“ one control and 3 experimental drugs. The encapsulation level of the implants was evaluated at 1 year after implantation; lower encapsulation is better in this study. Load and prepare data from sheet DataSet2.


## a)	Visualize your data.

### 1)	Create a histograms for each group in one ggplot call (not multiple separate figures, and be cautious with bins) (4 pts). 

```{r}
implant_restructured |> ggplot(aes(x=value)) +
  geom_histogram(bins = 10) +
  facet_wrap(vars(name))
```


### 2)	Create a bar plot that the shows the mean +/- st. dev of each group (4 pts).

```{r}

summarized_implant <- implant_restructured |>
  group_by(name) |>
  summarise(mean = mean(value),
            sd = sd(value),
            lower = mean - sd,
            upper = mean + sd) 


summarized_implant |>
  ggplot(aes(x = name, y = mean, fill = name)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.25) 

```

## b)	Describe your regression model

	Write out the formula for your regression model in generic terms (i.e., with $\beta$ terms and no specific values/numbers as we've not yet fit it) (3 pts).
	
$$y_i = \beta_0 + \beta_1x_{i1} + \beta_2x_{i2} + \beta_3x_{i3} + \epsilon_i$$


## c)	Fit your model

### 1)	What are the coefficients for your model (3 pts)?

```{r}
implant_lm <- lm(value ~ name, implant_restructured) 

tidy_implant <- tidy(summary(implant_lm))

tidy_implant

```

```{r}
mean_aerolcen <- pull(filter(tidy_implant, term=="(intercept)"), estimate)
mean_flepretreo <- pull(filter(tidy_implant, term=="nameFlepretreo"), estimate)
mean_quolorest <- pull(filter(tidy_implant, term=="nameQuolorest"), estimate)
mean_vehicle <- pull(filter(tidy_implant, term=="nameVehicle"), estimate)

print(paste0("Coefficient for flepretreo: ", mean_flepretreo))
print(paste0("Coefficient for quolorest: ", mean_quolorest))
print(paste0("Coefficient for vehicle: ", mean_vehicle))
```


#### i. Write out your model with the specific terms replaced by their estimate (as in b) (2pts)

$$y_i = 49.763606	 + -0.868605x_{i1} + -5.307889x_{i2} + 1.219402x_{i3} + \epsilon_i$$


### 2)	What is the sum of squares for the drug type in your model (2 pts)? 


```{r}
# Calculating the mean for all the diffusion rates
implant_restructured <- implant_restructured |> 
  mutate(mean_all = mean(value)) |>
  mutate(y_pred = fitted(implant_lm))

implant_ss_regression <- sum((implant_restructured$y_pred - implant_restructured$mean_all)^2)

print(paste0("Sum of squares for the drug type: ", implant_ss_regression))
```

## d)	Understand/Discuss your model

### 1)	Is the effect of drug type a significant explanation of the total variance in the model? (2 pts)

```{r}
summary(implant_lm)
```
**Answer: Yes, the type of drug significantly explains the total variance of the model. This is seen with the p-value of F-statistic for this linear model being less than 0.05.**

#### i.	What is the specific statistical hypothesis tested? (2 pts)

**Answer: The null hypothesis states that there is no significant effect of drug type on the response variable. This could be because the means of the response variable are similar across all drug types**

#### ii.	What type of statistic will you use to evaluate this test (2 pts)?

**Answer: We will use the F-statistic which tests whether the model is a good fit for the data. If it is, then this would suggest that at least one group mean is different from the others.**

#### iii.	What is the value of the statistic and what is the assiciated p-value (2 pts)?

```{r}
summary(implant_lm)
```

**Answer: F-statistic: 4.058; p-value: 0.007508 **


#### iv. What can you conclude and what can you not conclude based on this statistical test (4 pts)?

**Answer: You can conclude that there is a significant difference between one drug types group mean from the others if we assume a p-value threshold of 0.05 which it is currently under. You can not conclude that the drug caused changes in the dependent variable.**


# Problem #3 (30 pts): Brain natriurectic peptide (BNP) level in blood have been shown to predict heart failure, leading to alterations is cognitive function. In patients with high levels of BNP, your team evaluated the effects of different diuretic drugs on BNP levels. Load and prepare data from sheet DataSet3.   

## A) Provide a concise set of appropriate visualizations of the data (5 pts)

```{r}
bnp_restructured |> ggplot(aes(x=value, group=name, fill=name)) +
    geom_density(alpha=.4)
```



## B) a concise description of your approach to analyzing this data including generic formula given these data (5 pts) 

**Answer: **

$$y_i = \beta_0 + \beta_1x_{i1} + \beta_2x_{i2} + \beta_3x_{i3} + \epsilon_i$$



## C) Fit and interpret your model's summary and Anova tables (15 pts) 

```{r}
bnp_lm <- lm(value ~ name, bnp_restructured) 

summary(bnp_lm)
```

**Answer: The p-value of the F-statistic is 0.001838. Which suggests that the model is a good fit to the data if our threshold is 0.05. The estimate of the model's intercept is -18.874 with a p-value of 1.73e-05. This means that we can reject the null hypothesis that the intercept is 0 assuming a threshold of 0.05 for p-values.** 

**The estimate of the coefficient for the variable of whether the data point is furosemide is 7.624 with a p-value of 0.199287. This means we can not reject the null hypothesis that the coefficient is 0 for the variable of whether the data point is furosemide assuming a threshold of 0.05 for p-values.**

**The estimate of the coefficient for the variable of whether the data point is hydrochlorothiazide is 14.636 with a p-value of 0.014834. This means we can reject the null hypothesis that the coefficient is 0 for the variable of whether the data point is hydrochlorothiazide assuming a threshold of 0.05 for p-values.**

**The estimate of the coefficient for the variable of whether the data point is metolazone is 22.618 with a p-value of 0.000225. This means we can reject the null hypothesis that the coefficient is 0 for the variable of whether the data point is metolazone assuming a threshold of 0.05 for p-values.**


## E) What can you conclude scientifically as a result of your analysis and visualization? be concise but clear (5pts)

```{r}

```

