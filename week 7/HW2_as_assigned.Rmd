---
title: "Homework 2"
author: "Ryo Iwata"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr) # to render better tables
library(tidyverse)
library(tidymodels)
options(scipen = 2, digits = 4) # to control default number formatting
```
# Homework 2

## Instructions:

0. Start early and leave time to review and revise your submission well in advance of the due date.
1. Read the problem in its entirety before starting. Often, we can ignore certain variables while working on early problems and then pay attention to them in later problems. Students can waste time trying to incorporate these effects too early and with limited guidance on how to do this.
2. Plan your approach to tidying the data and preparing it for figures and analysis.
3. Translate your plan into well structured comments (in your code chunks)
4. Translate your comments into code, leaving the comments in place (so we understand your intent)
5. Ensure your code, figure and text answers are neat and tidy, grammatically correct, clear, and concise. You may find the reindent lines (ctrl-i) or reformat code (ctrl-A i.e. ctrl-shift-a) useful. Break arguments to functions onto different lines and ensure your code and comments do not flow off the edge of the page.
6. Review your output (pdf) to ensure your outputs render well. 
7. All tables, formulae, etc., should be carefully typeset. Do not just dump outputs from functions.

Note: We will grade both your answer and how you arrived at said answer (i.e., your code). Be sure to use sensible and sufficiently descriptive tibble, variable and model names. Make efficient and appropriate use of the tidyverse functionality. 

\newpage

# Problem \#1 (60 pts):

Your laboratory is evaluating the diffusion of drug delivery vehicles (particles) injected into the brain. The lab is seeking to understand how the diameter *and* surface charge of the drug delivery vehicle affects the vehicleâ€™s diffusion.

Load and evaluate the structure of data in HW2Data sheet DiffSizeCharge (only workbook/sheet in file)

```{r Loading in data}
drug_diffusion_raw <- readxl::read_excel("./data/HW2data.xlsx", sheet="DiffSizeCharge")
```


## 1) Investigate Particle Size and Diffusion Rate. At this point, ignore the effects of surface charge.

### a) Create a plot to visualize the effect of particle diameter on particle diffusion. Think about the regression model you may be fitting, and place the appropriate variables on the x axis and y axis. Do not include any summary or smooth geometries (2 pts)


```{r}
# Plotting scatter plot of Particle size against Diffusion rate
drug_diffusion_raw |> ggplot(aes(x=`Particle Size`, y=`Diffusion Rate`)) +
  geom_point() +
  labs(title = "Influence of Particle Size on Drug Delivery Vehicle Diffusion")

```


### b) Fit a univariate (1-variable) regression model to these data. (4 pts)

```{r}
# Regress diffusion rate onto particle size
size_to_diffusion_model <- lm(`Diffusion Rate` ~ `Particle Size`, drug_diffusion_raw)
```


### c) What are the model's estimated coefficients? Write out the generic formula for this model (i.e., with $\beta$ terms ) and then again with the estimates correctly substituted (4 pts)

```{r}
tidy_model_size_to_diffusion <- tidy(size_to_diffusion_model)

kable(tidy_model_size_to_diffusion)

intercept_size_to_diffusion_model <- pull(filter(tidy_model_size_to_diffusion, 
                                                 term=="(Intercept)"), estimate)
slope_size_to_diffusion_model <- pull(filter(tidy_model_size_to_diffusion, 
                                             term=="`Particle Size`"), estimate)

print(paste("Coefficient for intercept: ", intercept_size_to_diffusion_model))
print(paste("Coefficient for Particle Size: ", slope_size_to_diffusion_model))

```
**Answer: Generic formula for this model**
$\hat{y} = \beta_0 + \beta_{diameter}x_{diameter}$

**Answer: Formula for this model with the estimates substituted**
$\hat{y} = 8.3279 + -0.0204x_{diameter}$

### d) Calculate and present in a table the SS~x~, SS~y~, SS~xy~, SS~Regression~, and SS~Error~ for this model. (10 pts)

```{r}
# Adding lm information to data
augment_size_to_diffusion_model <- augment(size_to_diffusion_model)

# Testing if the regression coefficients are equal to zero
tidy_anova_size_to_diffusion <- tidy(car::Anova(size_to_diffusion_model))
```

```{r solutions}
size_to_diffusion_SSx <- pull(summarise(augment_size_to_diffusion_model, 
                      SSx = sum((`Particle Size` - mean(`Particle Size`))^2)
                      )
            )

# Calculating the sum of squares of Y, the predictor variable
size_to_diffusion_SSy <- pull(summarise(augment_size_to_diffusion_model, 
                      SSy = sum((`Diffusion Rate` - mean(`Diffusion Rate`))^2)
                      )
            )

# Calculating the sum of squares of X and Y
size_to_diffusion_SSxy <- pull(summarise(augment_size_to_diffusion_model, 
                       SSxy = sum((`Particle Size` - mean(`Particle Size`)) * (`Diffusion Rate` - mean(`Diffusion Rate`)) )
                       )
             )

# Calculating the sum of squares of regression or how well the model represents the data
size_to_diffusion_SSRegression <- pull(summarise(augment_size_to_diffusion_model, 
                               SSRegression = sum((.fitted - mean(`Diffusion Rate`)) ^ 2)
                               )
                     )

# Calculating the sum of squares of error/residual 
# which measures the discrepancy between the data and the model)
size_to_diffusion_SSerror <- pull(summarise(augment_size_to_diffusion_model, 
                          SSerror = sum((.fitted - `Diffusion Rate`) ^ 2)
                          )
                )

kable(tibble(term = c("SSx", "SSy", "SSxy", "SSRegression", "SSerror"),
             value = c(size_to_diffusion_SSx, size_to_diffusion_SSy, size_to_diffusion_SSxy, size_to_diffusion_SSRegression, size_to_diffusion_SSerror))
      )

```


```{r}
# Calculating the sum of squares of X, the predictor variable
SSx_size_to_diffusion <- pull(summarise(augment_size_to_diffusion_model, 
                      SSx = sum((`Particle Size` - mean(`Particle Size`))^2)
                      )
            )

# Calculating the sum of squares of error/residual 
# which measures the discrepancy between the data and the model)
SSerror_size_to_diffusion <- pull(filter(tidy_anova_size_to_diffusion, 
                                             term=="Residuals"), sumsq)

# Calculating the sum of squares of regression 
# or how well the model represents the data
SSregression_size_to_diffusion <- pull(filter(tidy_anova_size_to_diffusion, 
                                             term=="`Particle Size`"), sumsq)

# Calculating the sum of squares of Y, the predictor variable
SSy_size_to_diffusion <- SSerror_size_to_diffusion + SSregression_size_to_diffusion

# Calculating the sum of squares of X and Y
SSxy_size_to_diffusion <- pull(summarise(augment_size_to_diffusion_model, 
                       SSxy = sum((`Particle Size` - mean(`Particle Size`)) * 
                                    (`Diffusion Rate` - mean(`Diffusion Rate`))
                                  )
                       )
                       )

kable(tibble(term = c("SSx", "SSy", "SSxy", "SSRegression", "SSerror"),
             value = c(SSx_size_to_diffusion, SSy_size_to_diffusion, 
                       SSxy_size_to_diffusion, SSregression_size_to_diffusion, 
                       SSerror_size_to_diffusion)
             )
      )
```


### e) What is R^2^ for this model (2 pts)?

```{r}
# Calculating R^2, which is another measure of fit that is between 0 and 1
# Which is the proportion of the variability of Y that can be explained by X
size_to_diffusion_r_squared <- (size_to_diffusion_SSy - size_to_diffusion_SSerror) / size_to_diffusion_SSy

print(paste("R-squared for the model: ", size_to_diffusion_r_squared))

```

### f) Using the estimated slope term ($\beta$~1~) and its associated error, use a t-test to evaluate whether the slope term is zero or non-zero. What is the t-statistic and associated p-value (2 pts)?


```{r}
size_to_diffusion_diameter_tstat <- pull(filter(tidy_model_size_to_diffusion, term=="`Particle Size`"), 
                       statistic)

size_to_diffusion_diameter_t_pvalue <- pull(filter(tidy_model_size_to_diffusion, term=="`Particle Size`"), 
                        p.value)

print("t-statistic and associated p-value for slope term")
print(paste("T(", df.residual(size_to_diffusion_model), "):", 
            size_to_diffusion_diameter_tstat, 
            "p = ", size_to_diffusion_diameter_t_pvalue))

```

**Answer: Assuming significance with a p-value less than 0.05, we can reject the null hypothesis that the slope term is zero. Which is evidence suggesting a significant linear relationship between the independent and dependent variables in the model**


### g) Does particle size have a significant effect on particle diffusion with this model? (2 pts)

```{r}
kable(tidy_anova_size_to_diffusion)

size_to_diffusion_diameter_fstat <- pull(filter(tidy_model_size_to_diffusion, term=="`Particle Size`"), 
                       statistic)

size_to_diffusion_diameter_f_pvalue <- pull(filter(tidy_model_size_to_diffusion, term=="`Particle Size`"), 
                        p.value)

dfnum_size_to_diffusion <- 

print("F-statistic and associated p-value for all slope terms")
print(paste("F(", df.residual(size_to_diffusion_model), ",",
            
            "):", 
            size_to_diffusion_diameter_fstat, 
            "p = ", size_to_diffusion_diameter_pvalue))
```

**Answer: Assuming significance with a p-value less than 0.05, we can reject the null hypothesis that all slope coefficients in the model are equal to zero because the p-value for the F-statistic is lower than the threshold. This is evidence that the model fits the data significantly better than a model without predictors.**

```{r}
kable(tidy_model_size_to_diffusion)
```

**We can also reject the null hypothesis that the coefficient associated with particle size is equal to zero because the p-value for the t-statistic is lower than the threshold. The analysis suggests that particle size has a significant effect on particle diffusion because we have evidence that there is a significant linear relationship between particle size and particle diffusion.**




\newpage

## 2) In the same experiment, these particles had different surface charges. You decide to investigate the effect of surface charge on particle diffusion.

### a) Create a plot to visualize the effect of surface charge on particle diffusion in whole blood. At this point, ignore the effect of particle diameter (2 pts).

```{r}
drug_diffusion_raw |> ggplot(aes(x=`Surface Charge`, y=`Diffusion Rate`)) +
  geom_point()
```

### b) Fit a univariate (1-variable) regression model to these data. (4 pts)


### c) What are the model's estimated coefficients? Write out the formula for the model with generic terms as well as substituting the estimated coefficients (2 pts)


### d) Calculate and present in a table the SS~x~, SS~y~, SS~xy~, SS~Regression~, and SS~Error~ for this model. (10 pts)



### e) What is R^2^ for this model (2 pts)?


### f) Using the estimated slope term ($\beta$~1~) and its associated error, use a t-test to evaluate whether the slope term is zero or non-zero. What is the t-statistic and associated p-value (2 pts)?

### g) Does particle size have a significant effect on particle diffusion in this model? (2 pts)


\newpage

## 3) Multiple Regression

### a) Create a 2-D scatterplot to visualize combined effect of surface charge and particle diameter on particle diffusion in whole blood. Think about the regression model you may be fitting, and use appropriate aesthetic mappings. Do not include summary or smooth geoms/stats (3 pts).

```{r}
drug_diffusion_raw |> ggplot(aes(x=`Surface Charge`, y=`Diffusion Rate`, color=`Particle Size`)) +
  geom_point()

drug_diffusion_raw |> ggplot(aes(x=`Particle Size`, y=`Diffusion Rate`, color=`Surface Charge`)) +
  geom_point()
```


### b) Fit a 2-variable regression model to these data. Do not include any interactions or additional terms in your model. (4 pts)

```{r}
diameter_and_charge_model <- lm(`Diffusion Rate` ~ `Particle Size` + `Surface Charge`, drug_diffusion_raw)

```

```{r}
car::Anova(diameter_and_charge_model)
```

### c) What are the model coefficients and how do they compare to the prior models' coefficients? Write out all three model equations and evaluate. (6 pts)

```{r}
tidy_diameter_and_charge_model <- tidy(diameter_and_charge_model)

kable(tidy_diameter_and_charge_model)

tidy_diameter_and_charge_model

diff_model_intercept <- pull(filter(tidy_diameter_and_charge_model, term=="(Intercept)"), estimate)
diff_model_part_size_slope <- pull(filter(tidy_diameter_and_charge_model, term=="`Particle Size`"), estimate)
diff_model_part_charge_slope <- pull(filter(tidy_diameter_and_charge_model, term=="`Surface Charge`"), estimate)


print(paste("Coefficient for intercept: ", diff_model_intercept))
print(paste("Coefficient for Particle Size: ", diff_model_part_size_slope))
print(paste("Coefficient for Surface Charge: ", diff_model_part_charge_slope))


# TODO: Write out beta terms

```

### d) What are SS~ParticleSize~, SS~SurfaceCharge~, SS~ParticleSizeY~, SS~SurfaceChargeY~,SS~Y~, SS~Regression~, and SS~Error~ (10 pts)?


### e) What is R^2^ for this model (2 pts)?


### f) How does this model's R^2^ compare to the prior two models, and why is it so? (4 pts)?


### g) Use a t-test to evaluate whether each term is zero or non-zero. (4 pts)?


### h) Does size have a significant effect on particle diffusion and, if so, what is that effect? (2 pt)



### i) Does surface charge have a significant effect on particle diffusion and, if so, what is that effect? (2 pt)



### j) Extend your figures (use your code for your figures from part a of this problem as a base) to show both the raw data and the model **using geom_abline**. Do not use stat_smooth or other related functions. Think very carefully about where your model's plane is and where/how to represent it in your figures. (8 pt)

```{r}
mean_charge <- drug_diffusion_raw |> pull(`Surface Charge`) |>
  mean()

drug_diffusion_raw |> ggplot(aes(x=`Particle Size`, y=`Diffusion Rate`, color=`Surface Charge`)) +
  geom_point() +
  geom_abline(intercept=diff_model_intercept + diff_model_part_charge_slope * mean_charge, 
              slope=diff_model_part_size_slope)

```

### k) If you ran the experiment that resulted in this data, where would you put your focus for optimization of diffusion rate and why? (5 pts)

**Answer: Diameter because it signficantly affects diffusion rate while charge does not in a model that looks at both's effects independently.**

